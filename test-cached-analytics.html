<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Analytics - Cached Mode</title>
    <link rel="stylesheet" href="analytics.css">
    <script src="libs/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .test-mode-banner {
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            color: #000;
            padding: 10px 20px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            letter-spacing: 0.1em;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .test-controls {
            background: #111;
            border: 1px solid #333;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .test-controls button {
            background: #1d9bf0;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .test-controls button:hover {
            background: #1a8cd8;
        }

        .test-controls input {
            background: #222;
            border: 1px solid #333;
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            width: 200px;
        }

        main {
            padding-top: 50px;
        }

        /* Propagation modal layout - graph left, details right */
        #propagation-container {
            display: flex;
            gap: 0;
            height: 70vh;
            min-height: 500px;
        }

        #propagation-graph {
            flex: 1;
            min-width: 0;
            background: #000;
            border-right: 1px solid #333;
            overflow: hidden;
            position: relative;
        }

        #propagation-details {
            width: 0;
            flex-shrink: 0;
            background: #0a0a0a;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0;
            transition: width 0.2s ease;
        }

        #propagation-details.visible {
            width: 280px;
        }

        #propagation-details .details-placeholder {
            display: none;
        }

        /* Topic badge styling */
        .topic-badge {
            background: #333;
            color: #ffd700;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
    </style>
</head>

<body>
    <div class="test-mode-banner">
        ‚ö†Ô∏è TEST MODE - USING CACHED DATA ‚ö†Ô∏è
    </div>

    <main>
        <div class="test-controls">
            <button id="generate-btn">Generate Test Data</button>
            <input type="text" id="cache-id-input" placeholder="Cache ID or Space ID...">
            <button id="load-btn">Load Cache</button>
            <button id="load-real-btn" style="background: #00ba7c;">Load Real Space</button>
            <span id="cache-info" style="color: #666; font-size: 11px;"></span>
        </div>

        <div id="header-section">
            <div id="overall-score-container">
                <div id="overall-score-label">OVERALL CREDIBILITY</div>
                <div id="overall-score">--</div>
            </div>
            <h1 id="space-title">TEST ANALYTICS</h1>
        </div>

        <div id="average-score-widget">
            <div class="widget-title">SPEAKER SCORES</div>
            <div id="speaker1-avg" class="speaker-avg">
                <span class="speaker-name">--</span>
                <span class="speaker-avg-score">--</span>
            </div>
            <div id="speaker2-avg" class="speaker-avg">
                <span class="speaker-name">--</span>
                <span class="speaker-avg-score">--</span>
            </div>
        </div>

        <div id="chart-container">
            <canvas id="truth-score-chart"></canvas>
        </div>

        <div id="timeline-container"></div>

        <div id="details-widget">
            <div class="widget-title">MESSAGE DETAILS</div>
            <div id="node-details">
                <div class="details-placeholder">SELECT A MESSAGE TO VIEW DETAILS</div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="propagation-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>CLAIM PROPAGATION</h2>
            <div id="propagation-container">
                <div id="propagation-graph"></div>
                <div id="propagation-details"></div>
            </div>
        </div>
    </div>

    <div id="consistency-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeConsistencyModal()">&times;</span>
            <h2>CONSISTENCY ANALYSIS</h2>
            <div id="consistency-content"></div>
        </div>
    </div>

    <script>
        let allMessages = [];
        let chartInstance = null;
        let currentCacheId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const cacheId = urlParams.get('cacheId');
            const spaceId = urlParams.get('spaceId');

            if (spaceId) {
                // Load a real Supabase space
                document.getElementById('cache-id-input').value = spaceId;
                await loadRealSpace(spaceId);
            } else if (cacheId) {
                document.getElementById('cache-id-input').value = cacheId;
                await loadCachedData(cacheId);
            }

            // Setup event listeners
            document.getElementById('generate-btn').onclick = generateTestData;
            document.getElementById('load-btn').onclick = () => {
                const id = document.getElementById('cache-id-input').value.trim();
                if (id) loadCachedData(id);
            };
            document.getElementById('load-real-btn').onclick = () => {
                const id = document.getElementById('cache-id-input').value.trim();
                if (id) loadRealSpace(id);
            };

            // Modal close handlers
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.onclick = () => {
                    btn.closest('.modal').style.display = 'none';
                };
            });
        });

        async function loadRealSpace(spaceId) {
            try {
                document.getElementById('cache-info').textContent = 'Loading real space...';

                const response = await fetch(`http://localhost:3000/api/test/load-space/${spaceId}`);
                const data = await response.json();

                if (data.success && data.data) {
                    currentCacheId = data.cacheId;
                    document.getElementById('cache-info').textContent = `Loaded real space: ${spaceId}`;
                    window.history.pushState({}, '', `?spaceId=${spaceId}`);
                    updateDashboard(data.data);
                } else {
                    document.getElementById('cache-info').textContent = 'Space not found: ' + (data.error || spaceId);
                }
            } catch (error) {
                document.getElementById('cache-info').textContent = 'Error: ' + error.message;
            }
        }

        async function generateTestData() {
            try {
                document.getElementById('cache-info').textContent = 'Generating...';

                const response = await fetch('http://localhost:3000/api/test/generate-cached-analytics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        speakers: ['Donald Trump', 'Kamala Harris'],
                        messageCount: 20,
                        title: 'Test Debate - Generated'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('cache-id-input').value = data.cacheId;
                    document.getElementById('cache-info').textContent = `Generated: ${data.cacheId}`;
                    window.history.pushState({}, '', `?cacheId=${data.cacheId}`);
                    await loadCachedData(data.cacheId);
                } else {
                    document.getElementById('cache-info').textContent = 'Error: ' + data.error;
                }
            } catch (error) {
                document.getElementById('cache-info').textContent = 'Error: ' + error.message;
            }
        }

        async function loadCachedData(cacheId) {
            try {
                document.getElementById('cache-info').textContent = 'Loading...';

                const response = await fetch(`http://localhost:3000/api/test/cached-analytics/${cacheId}`);
                const data = await response.json();

                if (data.success && data.data) {
                    currentCacheId = cacheId;
                    document.getElementById('cache-info').textContent = `Loaded: ${cacheId}`;
                    updateDashboard(data.data);
                } else {
                    document.getElementById('cache-info').textContent = 'Cache not found';
                }
            } catch (error) {
                document.getElementById('cache-info').textContent = 'Error: ' + error.message;
            }
        }

        function updateDashboard(data) {
            const { space, messages } = data;
            allMessages = messages;

            // Header
            document.getElementById('space-title').textContent = (space.title || 'TEST ANALYTICS').toUpperCase();
            document.getElementById('overall-score').textContent = space.overall_credibility_score || '--';

            // Color code score
            const scoreEl = document.getElementById('overall-score');
            const score = space.overall_credibility_score;
            if (score >= 80) scoreEl.style.color = 'var(--success-color)';
            else if (score >= 50) scoreEl.style.color = 'var(--warning-color)';
            else scoreEl.style.color = 'var(--danger-color)';

            // Update displays
            renderTimeline(messages);
            renderChart(messages);
            updateAverageScores(messages);
        }

        // Include the core rendering functions from analytics.js
        // (Timeline, Chart, Details panel, etc.)

        function getScoreColor(score) {
            if (score === null || score === undefined) return '#333333';
            if (score <= 4) return '#8b0000';
            else if (score <= 7) return '#fbbf24';
            else return '#00ba7c';
        }

        function getVerdictColor(verdict) {
            switch (verdict?.toLowerCase()) {
                case 'true': return '#00ba7c';
                case 'false': return '#dc2626';
                case 'misleading': return '#f91880';
                case 'mixed': return '#ffd700';
                default: return '#71767b';
            }
        }

        // Helper to get speaker name with fallbacks
        function getSpeakerName(message) {
            return message.speaker_display_name ||
                message.speaker_name ||
                message.speaker_username ||
                message.speaker ||
                'Unknown Speaker';
        }

        function updateAverageScores(messages) {
            const speakerScores = {};
            messages.forEach(msg => {
                if (msg.truth_score !== null && msg.truth_score !== undefined) {
                    const speaker = getSpeakerName(msg);
                    if (!speakerScores[speaker]) {
                        speakerScores[speaker] = { total: 0, count: 0 };
                    }
                    speakerScores[speaker].total += msg.truth_score;
                    speakerScores[speaker].count++;
                }
            });

            const speakers = Object.keys(speakerScores).map(speaker => ({
                name: speaker,
                average: (speakerScores[speaker].total / speakerScores[speaker].count).toFixed(1)
            })).sort((a, b) => b.average - a.average);

            const speaker1El = document.getElementById('speaker1-avg');
            const speaker2El = document.getElementById('speaker2-avg');

            if (speakers.length >= 1 && speaker1El) {
                speaker1El.querySelector('.speaker-name').textContent = speakers[0].name.toUpperCase();
                speaker1El.querySelector('.speaker-avg-score').textContent = speakers[0].average + '/10';
            }
            if (speakers.length >= 2 && speaker2El) {
                speaker2El.querySelector('.speaker-name').textContent = speakers[1].name.toUpperCase();
                speaker2El.querySelector('.speaker-avg-score').textContent = speakers[1].average + '/10';
            }
        }

        function renderChart(messages) {
            const canvas = document.getElementById('truth-score-chart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            const speakers = {};
            messages.forEach((m, idx) => {
                const name = m.speaker_display_name || m.speaker_username || 'Unknown';
                if (!speakers[name]) speakers[name] = [];
                if (m.truth_score !== null && m.truth_score !== undefined) {
                    speakers[name].push({ x: m.sequence_number || idx, y: m.truth_score });
                }
            });

            const colors = ['#00ba7c', '#8b0000', '#fbbf24', '#1d9bf0'];
            const datasets = Object.keys(speakers).map((speaker, idx) => ({
                label: speaker,
                data: speakers[speaker].sort((a, b) => a.x - b.x),
                borderColor: colors[idx % colors.length],
                backgroundColor: colors[idx % colors.length],
                borderWidth: 2,
                pointRadius: 5,
                tension: 0.2,
                showLine: true
            }));

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff', font: { family: 'monospace' } } }
                    },
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            const datasetIdx = elements[0].datasetIndex;
                            const seq = chartInstance.data.datasets[datasetIdx].data[idx].x;
                            const msg = allMessages.find(m => m.sequence_number === seq);
                            if (msg) showMessageDetails(msg);
                        }
                    },
                    scales: {
                        x: { type: 'linear', ticks: { color: '#999' }, grid: { color: '#333' } },
                        y: { min: 0, max: 11, ticks: { color: '#999', stepSize: 1 }, grid: { color: '#333' } }
                    }
                }
            });
        }

        function renderTimeline(messages) {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '';

            const filtered = messages.filter(m => m.grok_verdict);
            if (filtered.length === 0) {
                container.innerHTML = '<div style="color: #666; text-align: center; padding: 40px;">No messages to display</div>';
                return;
            }

            const timeline = document.createElement('div');
            timeline.style.cssText = 'max-width: 900px; margin: 0 auto; padding: 40px 20px;';

            filtered.forEach((message, index) => {
                const card = document.createElement('div');
                const color = getScoreColor(message.truth_score);
                card.style.cssText = `background: #050505; border-left: 3px solid ${color}; padding: 15px 20px; margin-bottom: 15px; cursor: pointer;`;
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="color: #888; font-size: 11px; text-transform: uppercase;">${getSpeakerName(message)}</span>
                        <span style="color: ${color}; font-size: 14px; font-weight: bold;">${message.truth_score || '--'}/10</span>
                    </div>
                    <div style="color: #e7e9ea; font-size: 13px; line-height: 1.5;">${message.content}</div>
                    <div style="color: ${color}; font-size: 10px; margin-top: 8px; text-transform: uppercase;">${message.grok_verdict || ''}</div>
                `;
                card.onclick = () => showMessageDetails(message);
                timeline.appendChild(card);
            });

            container.appendChild(timeline);
        }

        function showMessageDetails(message) {
            const container = document.getElementById('node-details');
            const color = getVerdictColor(message.grok_verdict);

            container.innerHTML = `
                <div class="detail-item">
                    <div class="detail-label">SPEAKER</div>
                    <div class="detail-value">${getSpeakerName(message)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">MESSAGE #${message.sequence_number}</div>
                    <div class="detail-value quote">"${message.content}"</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">VERDICT</div>
                    <div class="detail-value" style="color: ${color};">
                        ${(message.grok_verdict || 'UNVERIFIED').toUpperCase()} (${message.truth_score || 'N/A'}/10)
                    </div>
                </div>
                ${message.grok_explanation ? `
                <div class="detail-item">
                    <div class="detail-label">EXPLANATION</div>
                    <div class="detail-value" style="font-size: 12px;">${message.grok_explanation}</div>
                </div>
                ` : ''}
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="dive-btn" onclick="testDiveDeeper('${message.id}', '${message.content.replace(/'/g, "\\'")}')">DIVE DEEPER ‚Üí</button>
                    <button class="dive-btn" style="border-color: #f91880; color: #f91880;" onclick="testConsistency('${getSpeakerName(message)}', '${message.content.replace(/'/g, "\\'")}')">CHECK CONSISTENCY</button>
                </div>
            `;
        }

        // Helper to format large numbers
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // D3 drag functionality
        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }
            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }
            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }
            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }

        function renderTestPropagationGraph(graphData, container) {
            const detailsPanel = document.getElementById('propagation-details');
            container.innerHTML = '';
            detailsPanel.innerHTML = '';
            detailsPanel.classList.remove('visible');

            const width = container.clientWidth || 800;
            const headerHeight = 80;
            const containerHeight = container.parentElement?.clientHeight || 550;
            const height = containerHeight - headerHeight;

            // Create header with better claim display
            const header = document.createElement('div');
            header.style.cssText = 'padding: 12px 15px; border-bottom: 1px solid #333; font-size: 11px; background: rgba(0,0,0,0.95); position: relative; z-index: 5;';

            // Intelligently truncate claim
            let claimText = graphData.claim_summary || 'Unknown claim';
            if (claimText.length > 120) {
                const sentEnd = claimText.substring(0, 120).lastIndexOf('.');
                if (sentEnd > 50) {
                    claimText = claimText.substring(0, sentEnd + 1);
                } else {
                    const wordEnd = claimText.substring(0, 120).lastIndexOf(' ');
                    claimText = claimText.substring(0, wordEnd) + '...';
                }
            }

            header.innerHTML = `
                <div style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                    <div style="color: #999; text-transform: uppercase; letter-spacing: 0.1em; font-size: 10px;">CLAIM BEING TRACED</div>
                    ${graphData.topic ? `<span class="topic-badge">${graphData.topic}</span>` : ''}
                </div>
                <div style="color: #e7e9ea; margin-bottom: 10px; line-height: 1.4; font-size: 12px;" title="${(graphData.claim_summary || '').replace(/"/g, '&quot;')}">"${claimText}"</div>
                <div style="display: flex; gap: 15px; font-size: 10px; flex-wrap: wrap;">
                    <span style="color: #00ba7c;">‚óè ${graphData.statistics?.supporters || 0} SUPPORTERS</span>
                    <span style="color: #f91880;">‚óè ${graphData.statistics?.contradictors || 0} CONTRADICTORS</span>
                    <span style="color: #71767b;">‚óè ${Math.max(0, (graphData.nodes?.length || 0) - (graphData.statistics?.supporters || 0) - (graphData.statistics?.contradictors || 0) - 1)} NEUTRAL</span>
                    <span style="color: #ffd700; margin-left: auto;">${formatNumber(graphData.statistics?.total_impressions || 0)} IMPRESSIONS</span>
                </div>
            `;
            container.appendChild(header);

            // Create SVG container - fill remaining space
            const svgContainer = document.createElement('div');
            svgContainer.style.cssText = `width: 100%; height: calc(100% - ${headerHeight}px); position: relative;`;
            container.appendChild(svgContainer);

            const svg = d3.select(svgContainer)
                .append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .style('cursor', 'grab');

            // Add zoom behavior
            const g = svg.append('g');
            const zoom = d3.zoom()
                .scaleExtent([0.3, 4])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });
            svg.call(zoom);

            // Click on background to hide details panel
            svg.on('click', (event) => {
                if (event.target.tagName === 'svg') {
                    detailsPanel.classList.remove('visible');
                    g.selectAll('circle').attr('stroke', '#333').attr('stroke-width', 1);
                }
            });

            // Prepare nodes and links
            const nodes = graphData.nodes || [];
            const links = graphData.links || [];

            // Calculate node sizes based on impressions
            const maxImpressions = Math.max(...nodes.map(n => n.impressions || 1));
            const minSize = 10;
            const maxSize = 55;

            nodes.forEach(node => {
                const impressions = node.impressions || 1;
                const normalized = impressions / maxImpressions;
                const powerScale = Math.pow(normalized, 0.5);
                node.radius = minSize + (maxSize - minSize) * powerScale;
            });

            // Color based on stance
            function getStanceColor(stance) {
                switch (stance?.toLowerCase()) {
                    case 'supports': return '#00ba7c';
                    case 'contradicts': return '#f91880';
                    case 'original': return '#ffd700';
                    default: return '#555'; // Darker gray for neutral
                }
            }

            // Get actual SVG dimensions
            const svgRect = svgContainer.getBoundingClientRect();
            const svgWidth = svgRect.width || width;
            const svgHeight = svgRect.height || height;

            // Create force simulation with stronger repulsion to spread nodes
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(150).strength(0.3))
                .force('charge', d3.forceManyBody().strength(-400))
                .force('center', d3.forceCenter(svgWidth / 2, svgHeight / 2))
                .force('collision', d3.forceCollide().radius(d => d.radius + 15))
                .force('x', d3.forceX(svgWidth / 2).strength(0.05))
                .force('y', d3.forceY(svgHeight / 2).strength(0.05));

            // Draw links with different styles based on type
            const link = g.append('g')
                .attr('stroke-opacity', 0.6)
                .selectAll('line')
                .data(links)
                .join('line')
                .attr('stroke', '#555')
                .attr('stroke-width', d => d.type === 'retweet' ? 2.5 : 1.5)
                .attr('stroke-dasharray', d => {
                    if (d.type === 'reply') return '6,3'; // Dashed for reply
                    if (d.type === 'quote') return '2,2'; // Dotted for quote
                    return null; // Solid for retweet
                });

            // Create node groups
            const node = g.append('g')
                .selectAll('g')
                .data(nodes)
                .join('g')
                .style('cursor', 'pointer')
                .call(drag(simulation))
                .on('click', (event, d) => {
                    event.stopPropagation(); // Prevent background click

                    // Highlight selected node
                    g.selectAll('circle').attr('stroke', '#444').attr('stroke-width', 1);
                    d3.select(event.currentTarget).select('circle')
                        .attr('stroke', '#fff')
                        .attr('stroke-width', 3);

                    // Show details panel
                    detailsPanel.classList.add('visible');
                    detailsPanel.innerHTML = `
                        <div style="padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 13px; font-weight: 600; color: #e7e9ea;">${d.display_name || d.username}</div>
                                ${d.verified ? '<span style="color: #1d9bf0; font-size: 12px;">‚úì</span>' : ''}
                            </div>
                            <div style="font-size: 11px; color: #1d9bf0; margin-bottom: 12px;">${d.username}</div>
                            <div style="font-size: 12px; color: #e7e9ea; margin-bottom: 12px; line-height: 1.5; border-left: 2px solid ${getStanceColor(d.stance)}; padding-left: 10px;">${d.tweet_text || 'No text'}</div>
                            <div style="font-size: 10px; color: #666; margin-bottom: 15px; display: flex; gap: 10px;">
                                <span>${formatNumber(d.impressions || 0)} impressions</span>
                                <span style="color: ${getStanceColor(d.stance)};">${d.stance}</span>
                            </div>
                            <a href="${d.tweet_url || '#'}" target="_blank" style="display: block; text-align: center; padding: 12px; background: #1d9bf0; color: #fff; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 12px;">
                                VIEW ON X ‚Üí
                            </a>
                        </div>
                    `;
                });

            // Draw circles
            node.append('circle')
                .attr('r', d => d.radius)
                .attr('fill', d => getStanceColor(d.stance))
                .attr('stroke', '#444')
                .attr('stroke-width', 1)
                .style('filter', d => d.stance === 'original' ? 'drop-shadow(0 0 8px rgba(255,215,0,0.5))' : 'none');

            // Add usernames as labels
            node.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', d => d.radius + 12)
                .attr('fill', '#888')
                .attr('font-size', '9px')
                .attr('pointer-events', 'none')
                .text(d => d.username?.replace('@', '').slice(0, 10) || '');

            // Update positions on tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            // Initial zoom to fit
            setTimeout(() => {
                svg.transition().duration(500).call(
                    zoom.transform,
                    d3.zoomIdentity.translate(svgWidth / 2, svgHeight / 2).scale(0.8).translate(-svgWidth / 2, -svgHeight / 2)
                );
            }, 500);

            // Add legend at the bottom
            const legend = document.createElement('div');
            legend.style.cssText = 'padding: 8px 15px; border-top: 1px solid #333; font-size: 9px; color: #888; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; background: rgba(0,0,0,0.95);';
            legend.innerHTML = `
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="width: 20px; height: 2px; background: #555; display: inline-block;"></span>
                    <span>RETWEET</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="width: 20px; border-top: 2px dashed #555; display: inline-block;"></span>
                    <span>REPLY</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="width: 20px; border-top: 2px dotted #555; display: inline-block;"></span>
                    <span>QUOTE</span>
                </div>
                <div style="margin-left: 10px; display: flex; gap: 12px;">
                    <span><span style="color: #ffd700;">‚óè</span> ORIGINAL</span>
                    <span><span style="color: #00ba7c;">‚óè</span> SUPPORTS</span>
                    <span><span style="color: #f91880;">‚óè</span> CONTRADICTS</span>
                    <span><span style="color: #555;">‚óè</span> NEUTRAL</span>
                </div>
                <button id="expand-graph-btn" style="margin-left: auto; background: #333; color: #e7e9ea; border: 1px solid #555; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 10px; text-transform: uppercase;">
                    + EXPAND GRAPH
                </button>
            `;
            container.appendChild(legend);

            // Store current graph data for expand functionality
            window.currentGraphData = graphData;
            window.currentClaim = graphData.claim_summary;

            // Add expand button click handler
            const expandBtn = legend.querySelector('#expand-graph-btn');
            expandBtn?.addEventListener('click', async () => {
                expandBtn.disabled = true;
                expandBtn.innerHTML = '‚è≥ LOADING...';
                try {
                    const response = await fetch('http://localhost:3000/api/analytics/dive-deeper', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            claim: window.currentClaim,
                            nodeCount: (window.currentGraphData?.nodes?.length || 40) + 30,
                            skipCache: true
                        })
                    });
                    const data = await response.json();
                    if (data.success && data.propagationGraph) {
                        renderTestPropagationGraph(data.propagationGraph, container);
                    }
                } catch (e) {
                    console.error('Expand graph error:', e);
                } finally {
                    expandBtn.disabled = false;
                    expandBtn.innerHTML = '+ EXPAND GRAPH';
                }
            });
        }

        async function testDiveDeeper(messageId, claim) {
            const modal = document.getElementById('propagation-modal');
            const container = document.getElementById('propagation-graph');
            const btn = event?.target;

            // Show loading state
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ LOADING...';
            }

            modal.style.display = 'block';
            container.innerHTML = `
                <div style="color: #fff; text-align: center; padding: 50px;">
                    <div class="spinner" style="border: 3px solid #333; border-top: 3px solid #1d9bf0; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <div>Searching X for related tweets...</div>
                    <div style="color: #666; font-size: 12px; margin-top: 10px;">This may take 10-20 seconds</div>
                </div>
                <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
            `;

            try {
                console.log('Calling dive-deeper API with claim:', claim.substring(0, 50) + '...');

                const response = await fetch('http://localhost:3000/api/analytics/dive-deeper', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messageId,
                        claim,
                        nodeCount: 40,
                        skipCache: true  // Test mode - always fetch fresh data
                    })
                });

                const data = await response.json();
                console.log('Dive-deeper response:', data);

                if (data.success && data.propagationGraph) {
                    // Use the D3 graph renderer
                    renderTestPropagationGraph(data.propagationGraph, container);
                } else {
                    container.innerHTML = `<div style="color: #f91880; padding: 50px; text-align: center;">Error: ${data.error || 'No propagation data returned'}</div>`;
                }
            } catch (e) {
                console.error('Dive deeper error:', e);
                container.innerHTML = `<div style="color: #f91880; padding: 50px; text-align: center;">Error: ${e.message}</div>`;
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'DIVE DEEPER ‚Üí';
                }
            }
        }

        async function testConsistency(speaker, claim) {
            const modal = document.getElementById('consistency-modal');
            const content = document.getElementById('consistency-content');
            const btn = event?.target;

            // Show loading state
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ LOADING...';
            }

            modal.style.display = 'block';
            content.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <div class="spinner" style="border: 3px solid #333; border-top: 3px solid #f91880; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <div>Analyzing ${speaker}'s past statements...</div>
                    <div style="color: #666; font-size: 12px; margin-top: 10px;">Searching X API and web sources</div>
                </div>
                <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
            `;

            try {
                const response = await fetch('http://localhost:3000/api/debate/consistency', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ speaker, claim })
                });
                const data = await response.json();

                if (data.success) {
                    content.innerHTML = `
                        <div style="display: flex; gap: 30px; max-height: 70vh; overflow-y: auto;">
                            <div style="flex: 0 0 150px; text-align: center; padding: 20px; border: 1px solid #333;">
                                <div style="font-size: 36px; color: ${data.score >= 7 ? '#00ba7c' : data.score >= 4 ? '#fbbf24' : '#dc2626'};">${data.score}/10</div>
                                <div style="font-size: 12px; color: #e7e9ea;">${data.verdict}</div>
                                <div style="font-size: 10px; color: #666; margin-top: 5px;">Source: ${data.data_source || 'N/A'}</div>
                                ${data.topic_match !== undefined ? `
                                    <div style="font-size: 9px; color: ${data.topic_match ? '#00ba7c' : '#fbbf24'}; margin-top: 8px;">
                                        ${data.topic_match ? '‚úì Topic matched' : '‚ö† Topic may not match'}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="flex: 1;">
                                <div style="margin-bottom: 15px;">
                                    <div style="color: #999; font-size: 10px; margin-bottom: 5px;">ANALYSIS</div>
                                    <div style="color: #e7e9ea;">${data.analysis}</div>
                                </div>
                                <div style="color: #999; font-size: 10px; margin-bottom: 5px;">PAST STATEMENTS (click to view source)</div>
                                ${(data.past_tweets || []).map(t => `
                                    ${t.url || t.source_url ? `
                                        <a href="${t.url || t.source_url}" target="_blank" style="text-decoration: none; display: block;">
                                    ` : '<div>'}
                                        <div style="background: #111; padding: 10px; margin-bottom: 5px; border-left: 2px solid #00ba7c; ${t.url || t.source_url ? 'cursor: pointer;' : ''}" ${t.url || t.source_url ? 'onmouseover="this.style.background=\'#1a1a1a\'" onmouseout="this.style.background=\'#111\'"' : ''}>
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div style="font-size: 10px; color: #666;">${t.date || 'Unknown date'}</div>
                                                ${t.url || t.source_url ? '<div style="font-size: 9px; color: #1d9bf0;">üîó View source</div>' : ''}
                                            </div>
                                            <div style="font-size: 12px; color: #e7e9ea; margin-top: 5px;">"${t.text}"</div>
                                            ${t.source ? `<div style="font-size: 9px; color: #666; margin-top: 5px;">Source: ${t.source}</div>` : ''}
                                        </div>
                                    ${t.url || t.source_url ? '</a>' : '</div>'}
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    content.innerHTML = `<div style="color: #f91880;">Error: ${data.error}</div>`;
                }
            } catch (e) {
                content.innerHTML = `<div style="color: #f91880;">Error: ${e.message}</div>`;
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'CHECK CONSISTENCY';
                }
            }
        }

        function closeConsistencyModal() {
            document.getElementById('consistency-modal').style.display = 'none';
        }
    </script>
</body>

</html>